{"diagram":{"image":{"height":200,"pngdata":"iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsUlEQVR4nO3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8GXHmAAFMgHIEAAAAAElFTkSuQmCC","width":200,"y":0,"x":0},"elements":{"id":"root","title":"ABP插件模块的开发？","structure":"mind_right","root":true,"theme":"basic","children":[{"tags":[{"text":"应用程序不依赖这个程序集","color":"#276F86","background":"#d6f0f8"}],"id":"f010bb61b2f8","title":"要解决几个常见问题","children":[{"id":"a3a0601b978a","title":"1. 插件中提供的功能需要权限认证，如何自动注册权限到使用了该插件的应用程序？","children":[],"parent":"f010bb61b2f8"},{"id":"5c9cf96ac5e1","title":"2.&nbsp;插件中提供的功能在展现层中需要菜单导航，如何自动注册菜单项目？","children":[],"parent":"f010bb61b2f8"},{"id":"02f56e045ab3","title":"3.&nbsp;插件中提供的功能需要配置，如何让插件自已能进行简单的配置管理，而不用去改宿主的配置文件？","children":[],"parent":"f010bb61b2f8"},{"id":"47055a131106","title":"4.&nbsp;插件中提供了新的Mvc Controller，当然也需要注册路由。","children":[],"parent":"f010bb61b2f8"}],"parent":"root","note":"插件程序集和应用程序是毫无关系的，应用程序不依赖这个程序集"},{"id":"73fb2e5357fd","title":"开发步骤","children":[{"id":"03725b1ed220","title":"1.&nbsp;新建插件程序集","children":[{"id":"f1ca521bca77","title":"a. 在解决方案中新建目录PlugIns，新建程序集项目Personball.PlugIns.PlugInZero；","children":[],"parent":"03725b1ed220"},{"id":"d0e65c6acd4b","title":"b.&nbsp;修改默认命名空间，由于这是一个插件，我选择默认命名空间为Personball.PlugIns，将PlugInZero作为这个示例插件的名称；","children":[],"parent":"03725b1ed220"},{"tags":[{"text":"保证和宿主使用的Abp框架版本一致","color":"#276F86","background":"#d6f0f8"}],"id":"e16a3c12c697","title":"c.&nbsp;在程序包管理其控制台，选择默认项目PlugIns\\Personball.PlugIns.PlugInZero，<br>执行Install-Package Abp.ZeroCore -Version 3.3.0<br>执行Install-Package&nbsp;Abp.AspNetCore -Version 3.3.0","children":[],"parent":"03725b1ed220","note":"(保证和宿主使用的Abp框架版本一致，可以减少很多不必要的麻烦)\n"},{"id":"ea1f5df986c7","title":"d.&nbsp;在插件程序集中添加一个目录PlugInZero，移除默认的Class1.cs。","children":[],"parent":"03725b1ed220"}],"parent":"73fb2e5357fd","icons":[{"text":"&#xe67e","index":"30","color":"rgb(48, 191, 191)","name":"flag"}]},{"id":"489917bc5a04","title":"2.&nbsp;注册权限","children":[{"id":"f8998cafe693","title":"插件本身也是一个模块，只要实现自己的AuthorizationProvider，并注册进Providers即可。","style":{"background-color":"#80bc42"},"children":[],"parent":"489917bc5a04","note":"Abp中权限构建基本都是通过继承AuthorizationProvider，实现SetPermissions方法，并添加到IAuthorizationConfiguration.Providers。\n插件本身也是一个模块，只要实现自己的AuthorizationProvider，并注册进Providers即可。\n在PlugInZero目录中定义我们的插件模块PlugInZeroModule"},{"id":"5798aadc7fb6","title":"在PlugInZero目录下新建常量定义文件PlugInZeroConsts&nbsp;用于权限的相关常量设定","style":{"background-color":"#7dcdc2"},"children":[],"parent":"489917bc5a04","icons":[{"text":"&#xe693","index":"61","name":""}],"note":"namespace Personball.PlugIns.PlugInZero\n{\n    public static class PlugInZeroConsts\n    {\n        public static class PermissionNames\n        {\n            public const string PlugIns = &quot;Personball.PlugIns&quot;;\n            public const string PlugInZero = &quot;Personball.PlugIns.PlugInZero&quot;;\n        }\n    }\n}"},{"id":"12c60b909ee6","title":"在PlugInZero目录下新建目录Authorization，新建类PlugInZeroAuthorizationProvider","style":{"background-color":"#7dcdc2"},"children":[],"parent":"489917bc5a04","icons":[{"text":"&#xe693","index":"61","name":""}],"note":"using Abp.Authorization;\nusing Abp.Localization;\n\nnamespace Personball.PlugIns.PlugInZero.Authorization\n{\n    public class PlugInZeroAuthorizationProvider:AuthorizationProvider\n    {\n        public override void SetPermissions(IPermissionDefinitionContext context)\n        {\n            //父节点\n            var parentPermission = context.GetPermissionOrNull(PlugInZeroConsts.PermissionNames.PlugIns);\n            if (parentPermission == null)\n            {\n                parentPermission = context.CreatePermission(\n                    PlugInZeroConsts.PermissionNames.PlugIns\n                    , new FixedLocalizableString(&quot;插件权限&quot;) //这里省略插件中的本地化机制\n                    , multiTenancySides: Abp.MultiTenancy.MultiTenancySides.Host\n                );\n            }\n\n            //权限\n            var menuPermission = parentPermission.CreateChildPermission(\n                PlugInZeroConsts.PermissionNames.PlugInZero\n                , new FixedLocalizableString(&quot;PlugInZero管理&quot;)\n                , multiTenancySides: Abp.MultiTenancy.MultiTenancySides.Host\n            );\n\n        }\n    }\n}"},{"id":"ff4d1c87baf4","title":"再到插件模块PlugInZeroModule中注册上述权限","children":[],"parent":"489917bc5a04","note":"using System.Reflection;\nusing Abp.AspNetCore;\nusing Abp.Modules;\nusing Personball.PlugIns.PlugInZero.Authorization;\n\nnamespace Personball.PlugIns.PlugInZero\n{\n    /// &lt;summary&gt;\n    /// 因为我们要用Mvc的Controller，这个要依赖一下\n    /// &lt;/summary&gt;\n    [DependsOn(typeof(AbpAspNetCoreModule))]\n    public class PlugInZeroMoudle:AbpModule\n    {\n        public override void PreInitialize()\n        {\n            //注册当前插件模块的权限\n            Configuration.Authorization.Providers\n                .Add&lt;PlugInZeroAuthorizationProvider&gt;();\n\n            //TODO:Wait.....\n        }\n\n        public override void Initialize()\n        {\n            IocManager.RegisterAssemblyByConvention(Assembly.GetExecutingAssembly());\n        }\n    }\n}"}],"parent":"73fb2e5357fd","icons":[{"text":"&#xe67e","index":"32","color":"rgb(255, 0, 0)","name":"flag"}]},{"id":"16bd33e0869b","title":"3.&nbsp;启用插件模块","children":[{"tags":[{"text":"ABP的动态加载模块","color":"#276F86","background":"#d6f0f8"}],"id":"4699a2a158b5","title":"1.&nbsp;在Web.Mvc的Startup中增加插件启动功能。","children":[],"parent":"16bd33e0869b","note":" //ABP的动态加载模块\n            return services.AddAbp&lt;DemoWebMvcModule&gt;(options =&gt;\n            {\n                var plugInsPath = $&quot;{_environment.ContentRootPath}\\\\PlugIns&quot;;\n                if (Directory.Exists(plugInsPath))\n                {\n                    //options.PlugInSources.Add(new FolderPlugInSource(@&quot;C:\\MyPlugIns&quot;));\n                    options.PlugInSources.AddFolder(plugInsPath); //比Add方法更简单点\n                }\n\n                // Configure Abp and Dependency Injection\n                options.IocManager.IocContainer.AddFacility&lt;LoggingFacility&gt;(f =&gt;\n                    f.UseAbpLog4Net().WithConfig(&quot;log4net.config&quot;)); // Configure Log4Net logging\n            });\n"},{"id":"3fa921408c9d","title":"2.&nbsp;为Web.Mvc&nbsp;项目增加一个目录PlugIns","children":[],"parent":"16bd33e0869b"},{"id":"f9a9387f1474","title":"3.&nbsp;生成插件程序集，将插件生成的Personball.PlugIns.PlugInZero.dll和Personball.PlugIns.PlugInZero.pdb复制到Web.Mvc的PlugIns目录下，启动Web.Mvc","children":[],"parent":"16bd33e0869b","note":""},{"id":"026d465ac48a","title":"4.&nbsp;启动后，登陆，点开Roles菜单，点开角色Admin的编辑弹窗，看权限的选项，确实增加了我们刚才在插件中定义的新权限！","children":[],"parent":"16bd33e0869b","note":"如果你有Asp.Net Zero的代码（收费的），那么权限编辑功能是可以直接使用的，这里官网免费生成的项目仅包含了module-zero基础功能，UI部分并未实现权限编辑功能。"}],"parent":"73fb2e5357fd","icons":[{"text":"&#xe693","index":"46","name":""}]},{"id":"bcf81612784a","title":"4.&nbsp;注册菜单","children":[{"id":"a73ba5106744","title":"菜单通过继承NavigationProvider，实现SetNavigation方法，并添加到INavigationConfiguration.Providers。<br>插件可以实现自己的NavigationProvider，并注册。<br>","style":{"background-color":"#80bc42"},"children":[],"parent":"bcf81612784a"},{"id":"e444e53e9d82","title":"在PlugInZero目录下新建目录Navigation，新建类PlugInZeroNavigationProvider","style":{"background-color":"#7dcdc2"},"children":[],"parent":"bcf81612784a","icons":[{"text":"&#xe693","index":"61","name":""}],"note":"using System.Linq;\nusing Abp.Application.Navigation;\nusing Abp.Localization;\nusing Microsoft.AspNetCore.Mvc.Routing;\n\nnamespace Personball.PlugIns.PlugInZero.Navigation\n{\n    public class PlugInZeroNavigationProvider : NavigationProvider\n    {\n        public override void SetNavigation(INavigationProviderContext context)\n        {\n            var hostMenu = context.Manager.MainMenu;\n            var plugInRoot = hostMenu.Items.FirstOrDefault(x =&gt; x.Name == &quot;PlugIns&quot;);\n            if (plugInRoot == null)\n            {\n                plugInRoot = new MenuItemDefinition(\n                    &quot;PlugIns&quot;\n                    , new FixedLocalizableString(&quot;插件模块&quot;)\n                    , url: &quot;PlugIns/PlugInZero&quot;\n                    , icon: &quot;menu&quot;\n\n                    //由于Demo目前无法编辑权限，暂时就不启用权限的依赖了\n                    //, requiredPermissionName: PlugInZeroConsts.PermissionNames.PlugIns\n                    );\n                hostMenu.AddItem(plugInRoot);\n            }\n\n            plugInRoot.AddItem(new MenuItemDefinition(\n                &quot;PlugInZero&quot;\n                ,new FixedLocalizableString(&quot;PlugInZero(插件)&quot;)\n                ,url:&quot;#&quot;\n                ,icon:&quot;&quot;\n                //,requiredPermissionName:PlugInZeroConsts.PermissionNames.PlugInZero\n\n            ));\n\n        }\n    }\n}"},{"id":"d810e822a28e","title":"再到插件模块PlugInZeroModule中注册菜单","children":[],"parent":"bcf81612784a"},{"id":"ae57bdfa228f","title":"来看看效果（生成插件程序集，并复制替换到Web.Mvc项目的PlugIns目录下）","children":[],"parent":"bcf81612784a"}],"parent":"73fb2e5357fd","icons":[{"text":"&#xe693","index":"56","name":""}]},{"id":"02efa3329378","title":"5.&nbsp;注册路由和寻找Controller","style":{"background-color":"#f384ae"},"children":[{"id":"5ae34fb12670","title":"首先我们提供一个PlugInZeroController，简单起见，仅有一个返回字符串的Action","children":[],"parent":"02efa3329378"},{"id":"f11b49905a44","title":"在PlugInZero目录下新建目录Controller，新建类PlugInZeroController","children":[],"parent":"02efa3329378","note":"using System;\nusing System.Threading.Tasks;\nusing Abp.AspNetCore.Mvc.Controllers;\nusing Microsoft.AspNetCore.Mvc;\n\nnamespace Personball.PlugIns.PlugInZero.Controller\n{\n\n    /// &lt;summary&gt;\n    /// 注：Abp建议的自定义一个继承AbpContrller的自已的基类，以便注入自已的属性\n    /// &lt;/summary&gt;\n    public class PlugInZeroController : AbpController\n    {\n        public PlugInZeroController()\n        {\n            LocalizationSourceName = &quot;Abp&quot;;\n        }\n\n        public Task&lt;string&gt; Hello()\n        {\n            return Task.FromResult($&quot;hello at {DateTime.Now}&quot;);\n        }\n\n        //// GET\n        //public IActionResult Index()\n        //{\n        //    return\n        //    View();\n        //}\n    }\n}"},{"id":"e79c2b06b562","title":"接着，我们注册下路由","style":{"background-color":"#99ffcc"},"children":[{"id":"e0ac6aa70b69","title":"1.&nbsp;在控制器头上加上[Route(\"Hello/[controller]/[action]\")]，第一个是区域","children":[],"parent":"e79c2b06b562"},{"id":"79e7defa239e","title":"2.&nbsp;自定义一个控制器基本，在头上加上[Area(\"Base\")]","children":[],"parent":"e79c2b06b562"},{"id":"d7bc5053a3c6","title":"3.&nbsp;在Web.Mvc的项目Startup中加上路由：","children":[],"parent":"e79c2b06b562","note":"routes.MapRoute(\n                    name: &quot;defaultWithArea&quot;,\n                    template: &quot;{area:exists}/{controller=Home}/{action=Index}/{id?}&quot;);"}],"parent":"02efa3329378","icons":[]},{"id":"29fe1cfc1188","title":"修改一下菜单项上的url，并指定链接的target(在PlugInZeroNavigationProvider中)","children":[],"parent":"02efa3329378"},{"id":"dcc80925785b","title":"更新插件程序集，启动，点击之前的插件菜单","children":[],"parent":"02efa3329378"}],"parent":"73fb2e5357fd","icons":[{"text":"&#xe6a0","index":"37","name":"arrow"}]},{"id":"ebf1e6810f63","title":"6.&nbsp;插件配置","children":[{"id":"40ea29a59f88","title":"如何提供插件单独的配置？","children":[{"id":"d687f211ebbb","title":"如果插件自身使用数据库，有个DbContext，怎么读取配置并让IoC构建DbContext时使用这个配置？","children":[],"parent":"40ea29a59f88"}],"parent":"ebf1e6810f63"}],"parent":"73fb2e5357fd","icons":[{"text":"&#xe693","index":"53","name":""}]}],"parent":"root","icons":[{"text":"&#xe693","index":"53","name":""}]}],"note":"参考文档：\n\nhttp://personball.com/abp/2017/08/21/abp-how-to-use-plugin\n"}},"meta":{"id":"5a66987be4b05a8ff314042e","member":"55506759e4b09739f462d50e","exportTime":"2018-02-26 16:58:58","diagramInfo":{"category":"mind_free","title":"如何使用ABP的插件模块进行开发？","created":"2018-01-23 10:05:47","creator":"55506759e4b09739f462d50e","modified":"2018-01-24 16:25:24"},"type":"ProcessOn Schema File","version":"1.0"}}